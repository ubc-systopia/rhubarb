#include <cstdint>
#include <type_traits>
// function templates
// adapted from https://github.com/becheran/fast-hilbert
template<typename T>
struct UnsignedTraits {
  using Key = typename std::conditional<std::is_same<T, uint8_t>::value, uint16_t,
              typename std::conditional<std::is_same<T, uint16_t>::value, uint32_t,
              typename std::conditional<std::is_same<T, uint32_t>::value, uint64_t,
              typename std::conditional<std::is_same<T, uint64_t>::value, __uint128_t,
              void>::type>::type>::type>::type;
  static constexpr T SEVEN = 7;
  static constexpr typename UnsignedTraits<T>::Key SIXTY_THREE = 63;
};

template<typename T>
typename UnsignedTraits<T>::Key xy2h(T x, T y, uint8_t order) {
  const uint8_t LUT_3[256] = {
          64,
          1,
          206,
          79,
          16,
          211,
          84,
          21,
          131,
          2,
          205,
          140,
          81,
          82,
          151,
          22,
          4,
          199,
          8,
          203,
          158,
          157,
          88,
          25,
          69,
          70,
          73,
          74,
          31,
          220,
          155,
          26,
          186,
          185,
          182,
          181,
          32,
          227,
          100,
          37,
          59,
          248,
          55,
          244,
          97,
          98,
          167,
          38,
          124,
          61,
          242,
          115,
          174,
          173,
          104,
          41,
          191,
          62,
          241,
          176,
          47,
          236,
          171,
          42,
          0,
          195,
          68,
          5,
          250,
          123,
          60,
          255,
          65,
          66,
          135,
          6,
          249,
          184,
          125,
          126,
          142,
          141,
          72,
          9,
          246,
          119,
          178,
          177,
          15,
          204,
          139,
          10,
          245,
          180,
          51,
          240,
          80,
          17,
          222,
          95,
          96,
          33,
          238,
          111,
          147,
          18,
          221,
          156,
          163,
          34,
          237,
          172,
          20,
          215,
          24,
          219,
          36,
          231,
          40,
          235,
          85,
          86,
          89,
          90,
          101,
          102,
          105,
          106,
          170,
          169,
          166,
          165,
          154,
          153,
          150,
          149,
          43,
          232,
          39,
          228,
          27,
          216,
          23,
          212,
          108,
          45,
          226,
          99,
          92,
          29,
          210,
          83,
          175,
          46,
          225,
          160,
          159,
          30,
          209,
          144,
          48,
          243,
          116,
          53,
          202,
          75,
          12,
          207,
          113,
          114,
          183,
          54,
          201,
          136,
          77,
          78,
          190,
          189,
          120,
          57,
          198,
          71,
          130,
          129,
          63,
          252,
          187,
          58,
          197,
          132,
          3,
          192,
          234,
          107,
          44,
          239,
          112,
          49,
          254,
          127,
          233,
          168,
          109,
          110,
          179,
          50,
          253,
          188,
          230,
          103,
          162,
          161,
          52,
          247,
          56,
          251,
          229,
          164,
          35,
          224,
          117,
          118,
          121,
          122,
          218,
          91,
          28,
          223,
          138,
          137,
          134,
          133,
          217,
          152,
          93,
          94,
          11,
          200,
          7,
          196,
          214,
          87,
          146,
          145,
          76,
          13,
          194,
          67,
          213,
          148,
          19,
          208,
          143,
          14,
          193,
          128,
  };

  const uint32_t coor_bits = sizeof(T) * 8;
  const uint32_t useless_bits = __builtin_clz(x | y) & ~1u;
  const uint8_t lowest_order = (coor_bits - useless_bits) + (order & 1);

  typename UnsignedTraits<T>::Key result = 0;
  uint8_t state = 0;
  int8_t shift_factor = lowest_order - 3;

  while (shift_factor > 0) {
    const T x_in = ((x >> shift_factor) & UnsignedTraits<T>::SEVEN) << 3;
    const T y_in = (y >> shift_factor) & UnsignedTraits<T>::SEVEN;

    const uint8_t index = x_in | y_in | state;

    const uint8_t r = LUT_3[index];
    state = r & 0b11000000;
    const typename UnsignedTraits<T>::Key hhh = r & UnsignedTraits<T>::SIXTY_THREE;
    const uint8_t shift = shift_factor << 1;
    result |= hhh << shift;
    shift_factor -= 3;
  }

  shift_factor *= -1;
  const T x_in = ((x << shift_factor) & UnsignedTraits<T>::SEVEN) << 3;
  const T y_in = (y << shift_factor) & UnsignedTraits<T>::SEVEN;

  const uint8_t index = x_in | y_in | state;
  const uint8_t r = LUT_3[index];
  const typename UnsignedTraits<T>::Key hhh = r & UnsignedTraits<T>::SIXTY_THREE;
  const uint8_t shift = shift_factor << 1;
  result |= hhh >> shift;

  return result;
}